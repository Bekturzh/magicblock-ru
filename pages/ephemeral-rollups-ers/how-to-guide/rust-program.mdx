---
title: "Программа для Solana "
description: "Узнайте, как написать простую программу на Rust, которая делегирует и увеличивает счётчик в Solana."
---

import Endpoints from "/snippets/endpoints.mdx";
import Validators from "/snippets/validators.mdx";
import SoftwareRust from "/snippets/software-rust.mdx";
import SolanaResources from "/snippets/solana-resources.mdx";

import DelegateCode from "/snippets/rust-counter-code/delegate.mdx";
import CommitCode from "/snippets/rust-counter-code/commit.mdx";
import UndelegateCode from "/snippets/rust-counter-code/undelegate.mdx";
import InstructionsCode from "/snippets/rust-counter-code/instructions.mdx";
import ResizeCode from "/snippets/rust-counter-code/resize.mdx";
import OncurveDelegation from "/snippets/oncurve-delegation.mdx";

import QuickAccesERRust from "/snippets/quick-access-er-rust.mdx";

---

<QuickAccesERRust />

---

<div style={{ position:"relative",paddingBottom:"56.25%",height:0,overflow:"hidden" }}>
<iframe src="https://www.youtube.com/embed/b77bwSGDHK0?si=Oknc5f8CuC17WBnV&list=PLWR_ZQiGMS8mIe1kPZe8OfHIbhvZqaM8V" title="Build a real-time Rust Counter on Solana with MagicBlock's Ephemeral Rollup | Tutorial" style={{ position:"absolute",top:0,left:0,width:"100%",height:"100%" }} frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowFullScreen referrerPolicy="strict-origin-when-cross-origin" />

</div>

---

## **Пошаговое руководство**

Соберите вашу программу и обновите её с хуками делегирования с помощью Delegation Program от MagicBlock`DELeGGvXpWV2fqJUhqcF5ZSYMS4JTLjteaAMARRSaeSh`:

<Steps>
  <Step title='
<a href="#1-write-program">
Write program and add delegation instructions
</a>
'>
    Пишите вашу программу на Solana так, как вы обычно это делаете.
  </Step>
  <Step title={<a href="#2-delegate">Delegate PDA on Base Layer</a>}>
    Добавьте CPI-хуки для делегирования, коммита и отмены делегирования аккаунтов состояния через сессии Эфимер Роллап

    <Validators />
  </Step>
  <Step title={<a href="#3-commit">Commit PDA on ER</a>}>
    Разверните вашу программу напрямую на Solana с помощью Solana CLI.
  </Step>
  <Step title={<a href="#4-undelegate">Undelegate PDA on ER</a>}>
    Отправляйте транзакции без изменений как в сети (on-chain), так и вне сети (off-chain), которые также соответствуют спецификации SVM RPC.
  </Step>
</Steps>

---

## Пример Счетчика 

<SoftwareRust />

### Code Snippets

<Tabs>
  <Tab title="1. Напишите программу">
    **Программа реализует две основные инструкции:**

    - **InitializeCounter:** Инициализирует счётчик и устанавливает его в 0 (вызывается на базовом слое, Base Layer)
    - **IncreaseCounter:** Увеличивает инициализированный счётчик на X (вызывается на базовом слое или в ER) 

      Программа реализует специальные инструкции для делегирования и отмены делегирования счётчика:
    - **Delegate:** Делегирует счётчик с базового слоя (Base Layer) в ER (вызывается на базовом слое)
    - **CommitAndUndelegate:** Планирует синхронизацию счётчика из ER в базовый слой и отменяет делегирование счётчика в ER (вызывается в ER)
    - **Commit:** Планирует синхронизацию счётчика из ER в базовый слой (вызывается в ER)
    - **Undelegate:** Отменяет делегирование счётчика на базовом слое (вызывается на базовом слое через CPI валидатора)

    Вот основная структура нашей программы:

    {" "}

    <InstructionsCode />

    <Note>
      Your "Undelegate" instruction must have the exact discriminator. It is never called by you, instead the validator on the Base Layer will callback with a CPI into your program after undelegating your account on ER.
    </Note>
    [⬆️ Вернуться к началу](#code-snippets)
  </Tab>
  <Tab title="2. Делегировать">
    ###  Делегирование PDA счётчика

    Чтобы делегировать PDA счётчика и сделать его доступным для записи в сессии Ephemeral Rollup, нам нужно добавить инструкцию, которая внутри вызывает функцию `delegate_account`. Функция `delegate_account` выполнит CPI к программе делегирования, которая после проверки получит владение аккаунтом. После этого эпемерный валидатор сможет начать обработку транзакций на PDA счётчика и предлагать изменения состояния через программу делегирования.

    <Card title="Транзакция (базовый слой): Делегировать" icon="magnifying-glass" iconType="duotone" href="https://solscan.io/tx/5jUdf5rsfQsbLYAahS9axrnLnEjdbUqtXUmGfgGuS7QqbYJ4FZHgXTNoT1bxPXp7XQu78r8Ebpp1RT2u9V6qsc1r?cluster=devnet">
      Просмотрите детали транзакций в Solana Explorer
    </Card>
    <DelegateCode />

    [⬆️ Вернуться к началу](#code-snippets)
  </Tab>
  <Tab title="3. Коммит">
    ### Коммитинг, пока PDA делегирован

    Эфемерная среда выполнения позволяет зафиксировать состояние PDA, пока он делегирован. Это выполняется вызовом функции `commit_accounts`.

    <CardGroup cols={2}>
      <Card title="Транзакция (ЭР): Коммит" icon="magnifying-glass" iconType="duotone" href="https://solscan.io/tx/5GiFGyrnJPkEQbhE8EHVYczoj2RPGe1YSnoq1DzcUHAxpyzMUKtxG2Tc7TLkxtcCHr72ftnvmkAVMfecTaf6TCK8?cluster=custom&customUrl=https://devnet.magicblock.app">
        Просмотрите детали транзакции в Solana Explorer
      </Card>
      <Card title="Транзакция (базовый слой): Коммит" icon="magnifying-glass" iconType="duotone" href="https://solscan.io/tx/5fHBADq99LAEBzGoeDXGtN3ut8RBf2s5UhbDM1N6TMTpvADNeYLz8e8vinNWj1VhLhrR7UxFoW7bo2u6pBR3YRjj?cluster=devnet">
        Просмотр деталей транзакции в Solana Explorer
      </Card>
    </CardGroup>
    <CommitCode />

    [⬆️ Вернуться к началу](#code-snippets)
  </Tab>
  <Tab title="4. Отменить делегирование">
    ### Отмена делегирования PDA

    Отмена делегирования PDA выполняется вызовом функции `commit_and_undelegate_accounts` в рамках какой-либо инструкции. При отмене делегирования фиксируется последнее состояние и возвращается владение PDA программе-владельцу. После отмены делегирования и финализации состояния валидатор создаёт callback CPI в функцию `undelegate` на базовом слое (Base Layer).

    <CardGroup cols={2}>
      <Card title="Транзакция (ЭР): Отменить делегирование" icon="magnifying-glass" iconType="duotone" href="https://solscan.io/tx/bMN6AhXrGH93Uc6ALibGgjnE39hcnY57mBhYkZ8TRaKxNRvyFaweaQPBmDxPv81cgR47WTTzzhfziTUEgAT8Y5m?cluster=custom&customUrl=https://devnet.magicblock.app">
        Просмотрите детали транзакции в Solana Explorer
      </Card>
      <Card title="Транзакция (базовый слой): Отменить делегирование" icon="magnifying-glass" iconType="duotone" href="https://solscan.io/tx/8JafYWiXmd4CHc2E97WKYnaNPmChZeg8aGYY7UUWaQ7Z54N5WoMcAVivyv2vdn9wKirMkR3y4UcmFPdXYqBtKAa?cluster=devnet">
        Просмотрите детали транзакции в Solana Explorer
      </Card>
    </CardGroup>
    <UndelegateCode />

    [⬆️ Вернуться к началу](#code-snippets)
  </Tab>
</Tabs>

---

### Расширенные Фрагменты Кода

<Tabs>
  <Tab title="Изменить размер PDA">
    **При изменении размера делегированного PDA:**

    - **PDA должен иметь достаточно лампортов**, чтобы оставаться освобождённым от арендной платы для нового размера аккаунта.
    - **Если требуется добавить дополнительные лампорты**, счётчик-плательщик должен быть делегирован для предоставления недостающей суммы.
    - **PDA должен принадлежать программе**, а транзакция должна включать всех необходимых подписантов для перевода лампортов.
    - **Используйте **`system_instruction::allocate`

    <ResizeCode />

    [⬆️ Вернуться к началу](#advanced-code-snippets)
  </Tab>
  <Tab title="Делегирование на кривой">
    <OncurveDelegation />

    [⬆️ Вернуться к началу](#advanced-code-snippets)
  </Tab>
</Tabs>

---

<SolanaResources />

---